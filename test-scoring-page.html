<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scoring Page</title>
</head>
<body>
    <h1>Testing Scoring Page Functionality</h1>
    <div id="results"></div>

    <script>
        const log = (message) => {
            const results = document.getElementById('results');
            results.innerHTML += `<p>${message}</p>`;
            console.log(message);
        };

        // Test scoring page navigation
        const testScoringPageAccess = async () => {
            log('ðŸ” Testing Scoring Page Access...');

            try {
                // First login to get auth token
                log('Step 1: Attempting login...');
                const loginResponse = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@gmail.com',
                        password: 'test@123-123'
                    })
                });

                if (!loginResponse.ok) {
                    log(`âŒ Login failed: ${loginResponse.status}`);
                    return;
                }

                const loginData = await loginResponse.json();
                localStorage.setItem('auth_token', loginData.token);
                log('âœ… Login successful, token stored');

                // Get available matches
                log('Step 2: Fetching available matches...');
                const matchesResponse = await fetch('http://localhost:3000/api/matches', {
                    headers: {
                        'Authorization': `Bearer ${loginData.token}`
                    }
                });

                if (!matchesResponse.ok) {
                    log(`âŒ Failed to fetch matches: ${matchesResponse.status}`);
                    return;
                }

                const matchesData = await matchesResponse.json();
                log(`âœ… Fetched matches successfully`);
                
                const allMatches = [
                    ...(matchesData.data?.created || []),
                    ...(matchesData.data?.invited || [])
                ];

                if (allMatches.length === 0) {
                    log('âš ï¸ No matches found. Creating a test match...');
                    await createTestMatch(loginData.token);
                    return;
                }

                const testMatch = allMatches[0];
                log(`ðŸ“‹ Testing with match: ${testMatch.venue} (${testMatch.matchCode})`);

                // Test scoring page API call
                log('Step 3: Testing match data API...');
                const matchDataResponse = await fetch(`http://localhost:3000/api/matches/${testMatch._id}`, {
                    headers: {
                        'Authorization': `Bearer ${loginData.token}`
                    }
                });

                if (!matchDataResponse.ok) {
                    log(`âŒ Failed to fetch match data: ${matchDataResponse.status}`);
                    const errorData = await matchDataResponse.json();
                    log(`Error details: ${JSON.stringify(errorData)}`);
                    return;
                }

                const matchData = await matchDataResponse.json();
                log('âœ… Match data fetched successfully');
                
                // Check match state
                const match = matchData.data;
                log(`ðŸ“Š Match State Analysis:`);
                log(`  Status: ${match.status}`);
                log(`  Toss Winner: ${match.toss_winner || 'Not completed'}`);
                log(`  Batting Team: ${match.batting_team || 'Not set'}`);
                log(`  Bowling Team: ${match.bowling_team || 'Not set'}`);
                
                if (match.scoringState) {
                    log(`  Scoring State Exists: Yes`);
                    log(`  Selected Batsman1: ${match.scoringState.selectedBatsman1 || 'Not selected'}`);
                    log(`  Selected Batsman2: ${match.scoringState.selectedBatsman2 || 'Not selected'}`);
                    log(`  Selected Bowler: ${match.scoringState.selectedBowler || 'Not selected'}`);
                } else {
                    log(`  Scoring State Exists: No`);
                }

                // Determine expected scoring page state
                if (!match.toss_winner) {
                    log('ðŸŽ¯ Expected Scoring Page State: TOSS form should be displayed');
                } else if (!match.scoringState?.selectedBatsman1) {
                    log('ðŸŽ¯ Expected Scoring Page State: PLAYER_SELECTION form should be displayed');
                } else {
                    log('ðŸŽ¯ Expected Scoring Page State: SCORING interface should be displayed');
                }

                // Test scoring API endpoint
                log('Step 4: Testing scoring API endpoint...');
                await testScoringAPI(testMatch._id, loginData.token);

            } catch (error) {
                log(`âŒ Error: ${error.message}`);
            }
        };

        const createTestMatch = async (token) => {
            log('Creating test match for scoring...');
            const createResponse = await fetch('http://localhost:3000/api/matches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    venue: 'Test Scoring Ground',
                    startTime: new Date().toISOString(),
                    overs: 10,
                    teamOne: {
                        name: 'Test Team A',
                        players: [
                            { name: 'Player A1', is_captain: true, is_keeper: false },
                            { name: 'Player A2', is_captain: false, is_keeper: true },
                            { name: 'Player A3', is_captain: false, is_keeper: false },
                        ]
                    },
                    teamTwo: {
                        name: 'Test Team B', 
                        players: [
                            { name: 'Player B1', is_captain: true, is_keeper: false },
                            { name: 'Player B2', is_captain: false, is_keeper: true },
                            { name: 'Player B3', is_captain: false, is_keeper: false },
                        ]
                    },
                    isPrivate: false
                })
            });

            if (createResponse.ok) {
                const matchData = await createResponse.json();
                log(`âœ… Test match created: ${matchData.data.matchCode}`);
            } else {
                log(`âŒ Failed to create test match: ${createResponse.status}`);
            }
        };

        const testScoringAPI = async (matchId, token) => {
            log('Testing scoring API with simple update...');
            
            const testUpdate = {
                status: 'live'
            };

            const response = await fetch(`http://localhost:3000/api/matches/${matchId}/score`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(testUpdate)
            });

            if (response.ok) {
                log('âœ… Scoring API responds correctly');
                const data = await response.json();
                log(`Response: ${JSON.stringify(data.success)}`);
            } else {
                log(`âŒ Scoring API failed: ${response.status}`);
                const errorData = await response.json();
                log(`Error: ${JSON.stringify(errorData)}`);
            }
        };

        // Run the test when page loads
        window.addEventListener('load', () => {
            log('ðŸš€ Starting scoring page tests...');
            testScoringPageAccess();
        });
    </script>
</body>
</html>